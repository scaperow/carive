{% extends "layout/cart.html" %}
{% block content %}
<!--<script src="/style2/js/bootstrap.js"></script>-->
<script type="text/javascript" src="/style2/js/confirmation.js?v=1.0.21"></script>
<script>
    var InterValObj; //timer变量，控制时间
    var count = 120; //间隔函数，1秒执行
    var curCount;//当前剩余秒数
    function sendMessage() {
        $("#err_msg").text("");
        var dianhua = {{user.mobile}};
    curCount = count;
    $("#getvcode").attr("disabled", "true");
    $("#getvcode").val(" " + curCount + "秒后可重新获取验证码");
    InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
    //向后台发送处理数据

    var xsrf = '{{handler.xsrf_token}}';
    $.post("/ajax/forget/vcode",
            {
                mobile: dianhua,
                _xsrf: xsrf
            },
            function (msg) {
                obj = jQuery.parseJSON(msg);
                if (obj.msg == 503) {
                    $("#err_msg").html("您发送短信过于频繁，请稍后再试");
                }
                else if (obj.msg == 500) {
                    $("#err_msg").html("短信发送失败，请稍后再试");
                }
                else if (obj.msg == 400) {
                    $("#err_msg").html("系统异常，请稍后再试");
                }else{
                    $("#err_msg").html(obj.msg);
                    $("#vcode").removeAttr("disabled");//启用按钮
                }
            });
    }
    //timer处理函数
    function SetRemainTime() {
        if (curCount == 0) {
            window.clearInterval(InterValObj);//停止计时器
            $("#getvcode").removeAttr("disabled");//启用按钮
            $("#getvcode").val("重新发送验证码");
            code = ""; //清除验证码。如果不清除，过时间后，输入收到的验证码依然有效
        }
        else {
            curCount--;
            $("#getvcode").val(" " + curCount + "秒后可重新获取验证码");
        }
    }
</script>

<div id="container" style="width: auto;">
    <link rel="stylesheet" href="/style2/css/jquery-ui-1.8.5.custom.css" type="text/css" media="screen" charset="utf-8" />
    <script type="text/javascript" charset="utf-8" src="/style2/js/jquery-ui-1.8.7.custom.min.js"></script>
    <link rel="stylesheet" href="/style2/css/confirmation.css" type="text/css" charset="utf-8" />

    <div id="cart">
        <form action="/alipay/topay" method="post" target="_blank" id="check_pay_form" onsubmit="return false;" autocomplete="off">
            {{xsrf()}}
            <input type="hidden" id="hidtn" name="tn" value="">
            <input type="hidden" id="hidprice" name="price" value="">
            <input type="hidden" id="hidblank" name="is_bank" value="">
            <input type="hidden" id="hidstoreid" name="storeid" value="0">
            <input type="submit" id="btnsub" style="display:none;">

            <input type="hidden" name="formToken" value="Cart_cftk_73621428114010">
            <div class="cart_left" style="*overflow: hidden">
                <input type="hidden" name="order_id" value="">
                <input type="hidden" name="web_site" value="bj" id="J_WebSite">
                <div class="option" id="address_selector">

                    <div class="title">1 地址选择</div>
                    <div id="first_add_address_wrap" style="display:none">
                        <div class="site_edit">
                            <div class="clearfix cow_box">
                                <div class="fl">
                                    <div class="fl lab_box"><label>收件人：<span class="tips">*</span></label></div>
                                    <div class="fl"><input type="text" class="input" id="JS_receiver_name" value="{{user.nickname|null|escape}}" name="receiver_name" maxlength="20" style="width: 190px;"></div>
                                    <div class="fl error_box JS_error_box" style="display:none;"><i class="sp_icon"></i><span class="txt">请填写正确的收货人姓名</span></div>
                                </div>
                            </div>
                            <div class="clearfix cow_box">
                                <div class="fl lab_box"><label>收货地址：<span class="tips">*</span></label></div>
                                <div class="fl clearfix">
                                    <div class="fl site_menu_box disabled JS_site_menu_box">
                                        <div>
                                            <select name="choose" id="ddlProvince" style="height:22px;">
                                            </select>
                                            <!--<a href="javascript:;" data-name="province" class="site_menu clearfix JS_site_menu">
                                                <span class="txt fl JS_site_txt" data="省/直辖市">陕西省</span>
                                                <span class="triangle_box fl"><i class="triangle_down"></i></span>
                                            </a>-->
                                        </div>
                                        <div class="site_menu_cont clearfix JS_site_menu_cont" style="display: none;"></div>
                                    </div>
                                    <div class="fl site_menu_box disabled JS_site_menu_box">
                                        <div>
                                            <select name="choose" id="ddlCity" style="height:22px;">
                                            </select>
                                        </div>
                                        <div class="site_menu_cont clearfix JS_site_menu_cont" style="display: none;"></div>
                                    </div>
                                    <div class="fl site_menu_box disabled JS_site_menu_box">
                                        <div>
                                            <select name="choose" id="ddlCounty" style="height:22px;">
                                            </select>
                                        </div>
                                        <div class="site_menu_cont clearfix JS_site_menu_cont" style="display: none;"></div>
                                    </div>
                                    <div class="fl site_menu_box disabled JS_site_menu_box" style="margin-right:0;">
                                        <div>
                                            <select name="choose" id="ddlStreet" style="height:22px;">
                                            </select>
                                        </div>
                                        <div class="site_menu_cont clearfix JS_site_menu_cont" style="display: none; right: 0px; left: auto;"></div>
                                    </div>
                                </div>
                                <div class="fl error_box" id="JS_error_sele_site" style="display:none;"><i class="sp_icon"></i><span class="txt">请选择收货地址所在的区/县</span></div>
                                <div class="fl error_box" id="JS_no_cod_tips" style="display:none;"><span class="txt" style="margin-left: 0;">（此地区不支持货到付款）</span></div>
                            </div>
                            <div class="clearfix cow_box">
                                <div class="fl lab_box"><label>详细地址：<span class="tips">*</span></label></div>
                                <div class="fl clearfix" style="width: 790px;">
                                    <div class="fl" id="JS_confirm_show_box"></div>
                                    <div class="fl clearfix" style="*width:660px;">
                                        <div class="fl"><input type="text" class="input" maxlength="100" name="address" id="JS_address" placeholder="请填写详细地址" style="width: 320px;"></div>
                                        <div class="fl error_box JS_error_box" style="display:none;"><i class="sp_icon"></i><span class="txt">请填写详细地址，不少于3个汉字，不能全部是数字/字母</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="clearfix cow_box">
                                <div class="fl lab_box"><label>手机号码：<span class="tips">*</span></label></div>
                                <div class="fl"><input type="text" class="input" id="JS_phone" maxlength="11" value="{{user.mobile|default('')}}" name="phone" style="width: 115px;"></div>
                                <div class="fl lab_box"><label>或固定电话：</label></div>
                                <div class="fl"><input type="text" placeholder="区号" class="input" id="JS_phone_area_new" maxlength="4" style="width: 50px;"></div>
                                <div class="fl" style="margin: 0 5px;">-</div>
                                <div class="fl"><input type="text" class="input" placeholder="电话号码" value="{{user.tel or ''}}" id="JS_phone_number_new" maxlength="8" style="width: 90px;"></div>
                                <div class="fl" style="margin: 0 5px;">-</div>
                                <div class="fl"><input type="text" class="input" placeholder="分机" id="JS_phone_ext_new" maxlength="8" style="width: 50px;"></div>
                                <div class="fl JS_tips" style="color: #999999;margin-left: 10px;">手机和固定电话请至少填写一个</div>
                                <div class="fl error_box JS_error_box" style="display:none;"><i class="sp_icon"></i><span class="txt">请填写正确的电话号码，手机号码为11位数字</span></div>
                            </div>
                            <div class="clearfix" style="margin-left: 95px;padding-top: 10px;"><a href="javascript:;" id="JS_new_address_submit_new" class="submit_btn">确定</a><a href="javascript:;" id="add_cancel" class="cancel_btn">取消</a></div>
                        </div>
                    </div>


                    <div id="default_address_wrap">
                        <div class="content" id="address_wrap">
                            {% for addritem in addritems %}
                            <div class="option_box {{ addritem.isdefault == 1 and 'selected' or '' }}" selector="old_address">
                                <input type="radio" id="address_{{ addritem.id }}" value="{{ addritem.id }}" data-default="{{addritem.isdefault}}" {{ addritem.isdefault == 1 and 'checked' or '' }} name="address_id" class="rdoAddress">
                                <label for="address_{{ addritem.id }}" data_address="{{ addritem.province }}-{{ addritem.city }}-{{ addritem.region }}" class="address_lbl"><span class="btnEditAddress_new" title="修改地址" addressid="{{ addritem.id }}">修改</span><span class="btnEditAddress_del" title="删除地址" addressid="{{ addritem.id }}">删除</span>            <p>
                                    <span class="addr_name">{{ addritem.name |escape}}</span>
                                    <span class="addr_con">{{ addritem.province|escape }}-{{ addritem.city|escape }}-{{ addritem.region|escape }}-{{ addritem.street|escape }} {{ addritem.address|escape }}</span>
                                    <span class="addr_num">{{ addritem.mobile|escape }} {{ addritem.tel|escape }} </span>
                                </p>        </label>
                                <div class="clear"></div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="address_btns_wrap">
                            <div class="address_more" style="display:none"><a href="javascript:void(0)" class="stri_open"><span></span>展开收货地址</a></div>
                            <a class="add_address_btn" href="javascript:void(0)">使用新地址</a>
                        </div>

                    </div>
                </div>
                <div class="clear"></div>
            </div>
            <div class="num_border"></div>
            <div class="cart_left cart_store_true"></div>
            <div class="cart_left cart_store">
                <div class="option" id="prefer_delivery_day">
                    <div class="title"><!-- if ($item['end_time'] > $time && $time >= $item['start_time']) {?> -->
                        2 送货时间
                        <span style="color:#666666;font-size:12px;font-weight:normal;font-family:'宋体';">送货时间仅作参考，快递公司会尽量满足您的要求</span></div>
                    <div class="content">
                        <div class="option_box option_default">
                            <input id="delivery_day_weekday" name="prefer_delivery_day" type="radio" value="weekday">
                            <label class="delivery_checked" for="delivery_day_weekday">仅工作日送货</label>
                            <div class="clear"></div>
                        </div>
                        <div class="option_box option_default">
                            <input id="delivery_day_weekend" name="prefer_delivery_day" type="radio" value="weekend">
                            <label class="delivery_checked" for="delivery_day_weekend">仅周末送货</label>
                            <div class="clear"></div>
                        </div>
                        <div class="option_box option_default selected">
                            <input id="delivery_day_" name="prefer_delivery_day" type="radio" value="" checked>
                            <label class="delivery_checked" for="delivery_day_">工作日/周末/假日均可</label>
                            <div class="clear"></div>
                        </div>

                        <div class="clb"></div>

                    </div>
                    <div style="color:#999;padding:20px 0 30px;clear:both;display: none;">预计发货时间：<span style="color:#000;">预计明日11:00 前发货，下午15-19点到达</span></div>

                </div>
            </div>
            <div class="num_border"></div>
            <div class="cart_left " style="*z-index: 5">
                <div class="option cart_products">
                    <div class="title">
                        3 商品清单
                    </div>
                    <input type="hidden" name="gids" value="{{gids}}">
                    <div class="cart_products_v2">
                        <h2><!--<span>此订单将从 <b>XX物流</b> 发出</span>-->
                            <a href="/cart/show" style="float: right">返回修改购物车</a>
                        </h2>
                        <table border="0" cellpadding="1" cellspacing="0" id="cart_products" width="100%">
                            <colgroup>
                                <col>
                                <col>
                                <col class="align_right">
                                <col class="align_right">
                            </colgroup>
                            <tbody><tr>
                                <th width="400" class="text_left padd_left">商品/规格</th>
                                <th width="110">数量</th>
                                <th width="140">单价</th>
                                <th width="140">小计</th>
                            </tr>
                            {% for cartitem in cartitems %}
                            <tr id="{{cartitem['uid']}}_{{cartitem['pid']}}" class="cart_item" deal_hash_id="{{cartitem['pid']}}">
                                <td class="name text_left padd_left">
                                    <input type="hidden" name="hdItems" value='{"psid": {{cartitem["psid"]}}, "price":{{cartitem["price"]}},"quantity": {{cartitem["quantity"]}}, "flag":{{cartitem["flag"]}}, "type":{{cartitem["type"]}}, "poid":{{cartitem["opid"]}}, "weight":{{cartitem["weight"]}}, "store":{{cartitem["store"]}} }'>
                                    <input type="hidden" name="pid_items" class="pid_items" value="{{cartitem['pid']}}">
                                    {% if cartitem['opid'] > 0 %}
                                    <input type="hidden" name="opid_items" class="opid_items" value="{{cartitem['opid']}}">
                                    {% endif %}
                                    <div style="width:320px;position: relative;line-height: 21px">
                                        <a href='/product/{{cartitem["psid"]}}' target="_blank" class="name_hover">
                                            {{cartitem['name']}}/ {{cartitem['standardname']}} <span style="color:red;">{% if cartitem['store_name'] %}({{cartitem['store_name']}}){% endif %}</span></a>
                                        <div class="pic_hover">
                                            <img src="{{cartitem['cover']}}" alt="{{cartitem['name']}}">
                                        </div>
                                    </div>
                                </td>
                                <td class="number_box">
                                    {{cartitem['quantity']}}
                                </td>
                                <td class="price_box">
                                    ¥<span id="item-buy-price-{{cartitem['pid']}}">{{cartitem['price']}}</span>
                                </td>
                                <td class="count_price_box bold">
                                    ¥<span id="item-buy-total-{{cartitem['pid']}}">{{cartitem['price'] * cartitem['quantity']}}</span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% for giftitem in giftitems %}
                            <tr class="cart_item" deal_hash_id="{{giftitem['pid']}}">
                                <td class="name text_left padd_left">
                                    <!--<input type="hidden" name="hdItems" value='{"psid": {{giftitem["psid"]}}, "price":{{giftitem["price"]}},"quantity": {{giftitem["quantity"]}}, "flag":{{giftitem["flag"]}} }'>-->
                                    <div style="width:320px;position: relative;line-height: 21px">
                                        <a href='/product/{{giftitem["psid"]}}' target="_blank" class="name_hover">
                                            {{giftitem['name']}}<span class="item_note"></span></a>
                                        <div class="pic_hover">
                                            <img src="{{giftitem['cover']}}" alt="{{giftitem['name']}}">
                                        </div>
                                    </div>
                                </td>
                                <td class="number_box">
                                    {{giftitem['quantity']}}
                                </td>
                                <td class="price_box">
                                    ¥<span>{{giftitem['price']}}</span>
                                </td>
                                <td class="count_price_box bold">
                                    ¥<span>{{giftitem['price'] * giftitem['quantity']}}</span>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="4" class="count" style="padding:10px 0 10px 30px;">
                                    <div class="content">
                                        <div class="option_box">
                                            <input id="Express_product/804/" type="radio" value="{{shopping_price}}" class="choose_delivery J_Express" name="logistic_preference" delivery_fee="5" checked="checked">
                                            <label for="Express_product/804/" id="label_express" class="J_label_express1">快递（5元，系统自动判断选择快递）</label>
                                            <div class="clear"></div>
                                        </div>
                                        <span class="express_num">¥<span class="exp_num J_Final_Delivery">5</span></span>
                                        <span class="express_tit">运费：</span>
                                    </div>
                                </td>
                            </tr>
                            <tr id="mjhdTr" style={% if (is_start == 1) and (totalPrice - shopping_price >= full_price) %}""{% else %} "display:none;"{% endif %}>
                                <td colspan="4" class="count" style="padding:10px 0 10px 30px;">
                                    <div class="content">
                                        <div class="option_box express_wrap">
                                            <span class="express_num" id="final" delivery_reduce="{{reduce_price}}">-¥<b class="J_Delivery_reduction">{{reduce_price}}</b></span>
                                            <span class="express_tit"><span>满减活动</span><b class="blue" style="font-size: 12px;font-weight: normal;">（已享受活动期间满<span class="full_reduce_price">{{full_price}}</span>元减{{reduce_price}}元）</b>：</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr id="yfTr" style={% if totalPrice - shopping_price >= 29 %}""{% else %} "display:none;"{% endif %}>
                                <td colspan="4" class="count" style="padding:10px 0 10px 30px;">
                                    <div class="content">
                                        <div class="option_box express_wrap">
                                            <span class="express_num" id="final_delivery_fee_redunction_notice_product/804/" delivery_reduce="5">-¥<b class="J_Delivery_reduction">5</b></span>
                                            <span class="express_tit"><span>运费减免</span><b class="blue" style="font-size: 12px;font-weight: normal;">（已享受活动期间满<span class="shiping_price">29</span>元免费包邮）</b>：</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <input type="hidden" id="hdBalance" value="0">
                            <input type="hidden" id="hdCouponPrice" value="0">
                            <input type="hidden" id="hdCurrentPrice" value="{{shopping_price+totalPrice}}">
                            <input type="hidden" class="J_Promo_cardno" name="coupon_code" value="">
                            <input type="hidden" class="J_Red_cardno" name="red_card[promo_cards/0/]" value="">
                            <input type="hidden" class="J_Red_totalPrice" name="sub_totalPrice" value="{{shopping_price+totalPrice}}">

                            <!--if order_type != 2-->
                            <tr class="order_amount">
                                <td colspan="4" style="padding:0;">
                                    <div class="order_amount_container">
                                        <a class="use_promo_card JS_use_promo_card" id="use_promo_card" href="#"><span class="corn">{{ coupon.count() > 0 and '-' or '+'}}</span>使用现金券和红包 </a>

                                        <div class="promo_card_box" style="display: {{ coupon.count() > 0 and 'block' or 'none'}};">
                                            <div class="hongbao_box" style="*z-index: 10">
                                                <div>
                                                    <div class="tr_promo_card" style="display: none;">
                                                        <span id="promo_card_reduction_notice_product/804/" class="express_num">- ¥<span class="exp_num promo_card_amount">0.00</span></span>
                                                        <span class="express_tit">现金券抵扣：</span>
                                                    </div>
                                                    <span class="promo_card_text">使用现金券：</span>

                                                    <a href="#" class="choose_promo_card" style="display: inline-block;">请选择您的现金券</a>
                                                    <a class="btn_con_small btn_con_gray confirm_promo_card" style="padding: 3px 10px;" type="button" onclick="cancelCoupon()" >取消</a>
                                                </div>
                                                <div class="choose_promo_card_box" style="visibility: visible; display: none;">
                                                    {% if coupon.count() > 0 %}
                                                    <ul style="overflow-y: hidden; height: auto;">
                                                        {% for c in coupon %}
                                                        <li style="border: none; height:30px;">
                                                <span>
                                                    <span class="pink" style="display: none;">{{c.coupontotal.price}}</span>
                                                    (<span class="sp_coupon_name">{{c.coupontotal.name}}</span>)
                                                </span>
                                                            <span class="promo_card_num" style="display:none;">{{c.code}}</span>
                                                            <br>
                                                            <span class="con_gray">{{c.endtime|datetimeformat}}到期</span>

                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                    <p><a href="#" class="close_promo_card">不使用现金券</a></p>
                                                    {% else %}
                                                    <p class="no_card">您没有现金券可用</p>
                                                    {% endif %}
                                                </div>
                                            </div>

                                        </div>
                                        <!--<div class="price_count express_num">-->
                                        <!--<div class="price">-->
                                        <span id="total_amount_product" style="display: none;" class="total_amount"> {{shopping_price+totalPrice}}</span>
                                        <!--</div>-->
                                        <!--</div>-->
                                        <!--<span class="express_tit">本单应付：</span>-->
                                        <div class="clear"></div>

                                    </div>
                                </td>
                            </tr>
                            <!--endif-->
                            </tbody></table>
                    </div>
                    <div class="orders_total_amount">
                        应付总额：<span class="total_count">¥<span id="cart_total">{% if (is_start == 1) and (shopping_price+totalPrice >= full_price) %}{{shopping_price+totalPrice-reduce_price}}{%else%}{{shopping_price+totalPrice}}{%endif%}</span></span>
                    </div>

                    <div class="inv_wrap" style="display: none;">
                        <input type="checkbox" class="is_need_inv" name="is_need_invoice" value="1"> 索要发票 <span class="inv_quesstion">
                <div style="display: none;">
                    1. <strong>发票类型：</strong>易凡目前只支持开具普通发票 <br>
                    2. <strong>发票金额：</strong>不包含运费金额以及现金券和红包抵扣的金额；<br>
                    3. <strong>发票内容：</strong><br>
                    1）订单中易凡发货的商品，由聚美开具发票，发票内容根据购买商品所属分类确定。<br>
                    2）订单中非易凡发货的商品，由商家开具发票，发票内容由商家决定。<br>
                    <a href="/help/fapiao" target="_blank">更多信息</a>
                    <span></span>
                </div>
            </span>
                        <div class="inv_info" style="display: block;">
                            <div class="inv_edit_wrap" style="">
                                <strong>发票抬头</strong>&nbsp;&nbsp;
                                <input type="radio" name="invoice_type" value="1"> 个人 &nbsp;&nbsp;&nbsp;
                                <input type="radio" name="invoice_type" value="2" checked="true"> 单位 <input type="text" class="inv_type_name" name="invoice_companyname" maxlength="200" value="" focustxt="请输入单位名称">&nbsp;&nbsp;<span class="inv_error" style="display: none;">请输入正确的单位名称</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="num_border"></div>

            <div class="cart_left cart_store cart_left_last">
                <div class="option">
                    <div class="paytype">
                        <div id="paytype_gateway" class="paytype_gateway_after">

                            <div id="gateway_list" class="gateway_list" style="_height: 1%">
                                <div class="title">4 支付方式</div>
                                <div class="adv" style="display:none">
                                </div>


                                <div class="gateway_ul_box">


                                    <input type="hidden" class="hid_balance" value="{{balance}}">
                                    <ul class="gateway_ul">
                                        <li class="gateway_line" style="display: none;">
                                            <input type="radio">
                                            <label class="tit" for="">支付宝/财付通/第三方支付方式</label>
                                            <label class="tit gateway_desc cup_activity_cod" style="">
                                                <!--首次使用百度钱包快捷支付付款，满49立减20元，数量有限，先到先得。-->
                                                <a href="javascript:void(0)">
                                                    活动规则
                                                    <div>
                                                        1、2014年9月10日-12月31日，参与活动的用户在PC端下单并支付，且是历史首次使用快捷支付，可享受每笔订单立减20元的优惠。<br>
                                                        2、活动期间每位用户只可享受1次下单立减优惠，同一银行账号、同一手机号、同一身份证号，满足任一条件均视为同一用户。<br>
                                                        3、享受立减优惠后，如果发生退款，优惠金额不予退回；优惠实时发放，无中奖名单公告或通知。<br>
                                                        4、限量30000个机会，先到先得。<br>
                                                        5、若使用过程中出现问题，请联系百度钱包：{{handler.settings['com_tel']}}。<br>
                                                        6、活动过程中如发现违规行为,自动取消其活动资格并追究其法律责任。
                                                        <span></span>
                                                    </div>
                                                </a>
                                            </label>
                                            <ul class="third_ul clearfix g_ul">
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Alipay" name="gateway" id="check-Alipay">
                                                        <label class="bg Alipay" for="check-Alipay"></label>
                                                    </div>
                                                </li>
                                                <li style="display:none;">
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Tenpay_0" name="gateway" id="check-Tenpay_0">
                                                        <label class="bg Tenpay_0" for="check-Tenpay_0"></label>
                                                    </div>
                                                </li>
                                                <li style="display:none;">
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Unionpay" name="gateway" id="check-Unionpay">
                                                        <label class="bg Unionpay" for="check-Unionpay"></label>
                                                    </div>
                                                </li>
                                                <li style="display: none;">
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_baifubao" name="gateway" id="check-Bfb_baifubao">
                                                        <label class="bg Bfb_baifubao" for="check-Bfb_baifubao"></label>
                                                    </div>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="gateway_line gateway_banance ul_off radioBalance" style="/*padding-left: 15px; line-height: 60px;*/">

                                            <input id="radio-balance" class="radio-control radioBalance" type="radio" name="gateway" {{paytype=='2' and 'checked' or ''}} value="Balance">
                                            <label class="tit radio-control radioBalance" for="radio-balance">余额支付 &nbsp;&nbsp;当前余额 <span style="font-weight: 100; color: #ed415b">{{balance}}</span> 元</label>
                                            <div class="right_Price radio-control radioBalance" style="float: right;padding-right: 25px; line-height: 40px; display: none;">
                                                <span class="rightPrice">支付 <span class="getewey_price">{{shopping_price+totalPrice}}</span> 元</span>
                                            </div>
                                        </li>
                                        <li class="gateway_line gateway_banance ul_off checkBalance" style="/*padding-left: 15px; line-height: 60px;*/">

                                            <input id="check-balance" class="check-control checkBalance" type="checkbox" name="balance" {{balance or 'disabled' }} value="Balance">
                                            <label class="tit check-control checkBalance" for="check-balance">余额支付 &nbsp;&nbsp;当前余额 <span style="font-weight: 100; color: #ed415b">{{balance}}</span> 元</label>
                                            <span class="check-control checkBalance"><a href="/user/top_up?price={{totalPrice-balance}}" style="color: #0099FF;">去充值</a></span>
                                            <div class="right_Price check-control checkBalance" style="float: right;padding-right: 25px; line-height: 40px; display: none;">
                                                <span class="rightPrice">支付 <span class="balance_price">{{balance}}</span> 元</span>
                                            </div>


                                        </li>

                                        <li class="gateway_line {{paytype=='2' and 'ul_off' or 'ul_on'}}" id="last_choose_mode">
                                            <input type="radio" name="gateway" id="choose_before" {{paytype!='2' and 'checked' or ''}} value="Alipay">
                                            <label class="tit" for="choose_before">第三方支付方式</label>
                                            <label class="Alipay bg" for="choose_before"></label>
                                            <label class="tit no_cod" style="display: none;"></label>
                                            <div class="rightPrice" style="float: right;padding-right: 25px; line-height: 40px; display: none;">
                                                支付 <span class="getewey_price">{% if balance >= totalPrice %}{{shopping_price+totalPrice}}{%else%}{{ totalPrice-balance}}{% endif %}<!--{{totalPrice}}--></span> 元
                                            </div>
                                        </li>
                                        <!--if order_type != 2-->
                                        <li class="gateway_line gateway_COD ul_off" style="display: none;/*list-item;*/">
                                            <input type="radio" name="gateway" value="COD" id="check-cod"><label class="tit" for="check-cod">货到付款</label>
                                            <label class="tit no_cod" style="display: none;"></label>
                                            <div class="rightPrice" style="float: right;padding-right: 25px; line-height: 40px; display: none;">
                                                支付 <span class="getewey_price">{% if balance >= totalPrice %}{{shopping_price+totalPrice}}{%else%}{{ totalPrice-balance}}{% endif %}<!--{{totalPrice}}--></span> 元
                                            </div>
                                        </li>
                                        <!--endif-->
                                        <li class="gateway_line ul_off gateway_bank">
                                            <input type="radio" id="check-other"><label class="tit" for="">网上银行</label><label class="tit gateway_desc" for=""><span>支持地方银行，需开通网银支付功能</span></label>
                                            <div class="rightPrice" style="float: right;padding-right: 25px; line-height: 40px; display: none;">
                                                支付 <span class="getewey_price">{% if balance >= totalPrice %}{{shopping_price+totalPrice}}{%else%}{{ totalPrice-balance}}{% endif %}<!--{{totalPrice}}--></span> 元
                                            </div>
                                            <ul class="bank_ul clearfix g_ul">

                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CCB" name="gateway" id="check-Alipay_CCB">
                                                        <label class="bg Alipay_CCB" for="check-Alipay_CCB"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="ICBCB2C" name="gateway" id="check-Alipay_ICBCB2C">
                                                        <label class="bg Alipay_ICBCB2C" for="check-Alipay_ICBCB2C"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="BOCB2C" name="gateway" id="check-Alipay_BOCB2C">
                                                        <label class="bg Alipay_BOCB2C" for="check-Alipay_BOCB2C"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="ABC" name="gateway" id="check-Alipay_ABC">
                                                        <label class="bg Alipay_ABC" for="check-Alipay_ABC"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CMB" name="gateway" id="check-Alipay_CMB">
                                                        <label class="bg Alipay_CMB" for="check-Alipay_CMB"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="COMM" name="gateway" id="check-Alipay_COMM">
                                                        <label class="bg Alipay_COMM" for="check-Alipay_COMM"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CEB-DEBIT" name="gateway" id="check-Bfb_CEBBANK">
                                                        <label class="bg Bfb_CEBBANK" for="check-Bfb_CEBBANK"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="PSBC-DEBIT" name="gateway" id="check-Alipay_PSBC-DEBIT">
                                                        <label class="bg Alipay_PSBC-DEBIT" for="check-Alipay_PSBC-DEBIT"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CIB" name="gateway" id="check-Alipay_CIB">
                                                        <label class="bg Alipay_CIB" for="check-Alipay_CIB"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="GDB" name="gateway" id="check-Bfb_GDB">
                                                        <label class="bg Bfb_GDB" for="check-Bfb_GDB"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="SPDB" name="gateway" id="check-Alipay_SPDB">
                                                        <label class="bg Alipay_SPDB" for="check-Alipay_SPDB"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CITIC" name="gateway" id="check-Alipay_CITIC">
                                                        <label class="bg Alipay_CITIC" for="check-Alipay_CITIC"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="CMBC" name="gateway" id="check-Bfb_CMBC">
                                                        <label class="bg Bfb_CMBC" for="check-Bfb_CMBC"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="SPABANK" name="gateway" id="check-Bfb_SPABANK">
                                                        <label class="bg Bfb_SPABANK" for="check-Bfb_SPABANK"></label>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="BJBANK" name="gateway" id="check-Alipay_BJBANK">
                                                        <label class="bg Alipay_BJBANK" for="check-Alipay_BJBANK"></label>
                                                    </div>
                                                </li>
                                            </ul>
                                        </li>
                                        <li class="gateway_line ul_off" style="display: none;">
                                            <input type="radio" id=""><label class="tit" for="">快捷支付</label><label class="tit gateway_desc" for=""><span>支持信用卡付款，无需开通网银支付功能</span></label>
                                            <ul class="speedy_ul clearfix g_ul">
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_CMB-EXPRESS-CREDIT" name="gateway" id="check-CMB-EXPRESS-CREDIT">
                                                        <label class="bg Alipay_CMB-MOTO-CREDIT" for="check-CMB-EXPRESS-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_CCB-MOTO-CREDIT" name="gateway" id="check-CCB-MOTO-CREDIT">
                                                        <label class="bg Bfb_CCB-MOTO-CREDIT" for="check-CCB-MOTO-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_BOC-MOTO-CREDIT" name="gateway" id="check-BOC-MOTO-CREDIT">
                                                        <label class="bg Bfb_BOC-MOTO-CREDIT" for="check-BOC-MOTO-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_ICBC-MOTO-CREDIT" name="gateway" id="check-ICBC-MOTO-CREDIT">
                                                        <label class="bg Bfb_ICBC-MOTO-CREDIT" for="check-ICBC-MOTO-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_CITIC-EXPRESS-CREDIT" name="gateway" id="check-CITIC-EXPRESS-CREDIT">
                                                        <label class="bg Bfb_CITIC-EXPRESS-CREDIT" for="check-CITIC-EXPRESS-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_CEB-EXPRESS-CREDIT" name="gateway" id="check-CEB-EXPRESS-CREDIT">
                                                        <label class="bg Bfb_CEB-EXPRESS-CREDIT" for="check-CEB-EXPRESS-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_SPABANK-MOTO-CREDIT" name="gateway" id="check-SPABANK-MOTO-CREDIT">
                                                        <label class="bg Bfb_SPABANK-MOTO-CREDIT" for="check-SPABANK-MOTO-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                                <li>
                                                    <div class="bd_wrap">
                                                        <input type="radio" value="Bfb_GDB-EXPRESS-CREDIT" name="gateway" id="check-GDB-EXPRESS-CREDIT">
                                                        <label class="bg Bfb_GDB-EXPRESS-CREDIT" for="check-GDB-EXPRESS-CREDIT"></label>
                                                        <span>快捷</span>
                                                    </div>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                    <div class="inv_wrap" >
                                        <p style="line-height: 25px;"><input type="checkbox" class="is_message" name="is_messageoice" value="0">我要留言</p>
                                        <div class="inv_info_message" style="display: block;">
                                            <div class="inv_edit_message" style="">
                                                <textarea id="txtMessage" name="txtmessage" style="width:100%; height:100px;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="hidBalance" name="hidBalance" value="{{totalPrice}}">
                            <input type="hidden" id="hidPay" name="hidPay" value="{{ totalPrice > balance and totalPrice-balance or balance}}">
                            <div class="inv_wrap validation" style="display: none; text-align: right;">
                                <label class="control-label" style="color: red;">
                                    {%set messages=handler.get_flashed_messages() %}
                                    {%-if messages-%}
                                    {% for type, msg in messages%}
                                    提示： {{msg}}
                                    {% endfor %}
                                    {%-endif-%}
                                </label>
                                <label  id="err_msg"  class="control-label" style="color:red;"></label>
                                <input type="button" class="btn btn-warning" style=" width:180px;" id="getvcode" onclick="javascript: sendMessage(); return false;" value="免费获取验证码" />
                                <label class="control-label">验证码</label>
                                <input style="width: 100px;height:30px;"  class="form-control" maxlength="6" type="text" name="vcode" placeholder="请输入验证码" id="vcode" value="" required="" title="请输入6位数字验证码" pattern="^\d{6}$" />

                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="sure_payinfo_wrap">
                <div class="confirm_pay_box">
                    <div class="confirm_pay">
                        <a href="/cart/show" class="btn_grey_small">返回修改购物车</a>
                        <input type="submit" id="btn_confirm_pay" class="btn_pink_big" value="确认订单" onclick="return check_pay();">
                        <div class="price_sum">
                            应付总额：<span class="total_count">¥<span id="cart_total2">{{shopping_price+totalPrice}}</span></span>
                        </div>
                        {% if order_type == 2 %}
                        <span style="line-height: 40px; color: #ed415b; font-size: 18px; font-weight: bold; float: right;">
                            您的订单中包含预订商品，订单将按照预订商品时间送达。</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="cart_side_nav"><a href="javascript:;"></a></div>


</div>

<div id="lightbox_shadow" style="height: 2000px; display: none;"><iframe frameborder="0" style="height: 849px;"></iframe></div>
<div id="lightbox" style="left: 50%; margin: 0px 0px 0px -201px; top: 150px; z-index: 5;display: none;">
    <div class="container">
        <div class="title">请付款 <div class="close_button"></div></div>
        <div class="content" style="line-height:30px;">
            <h1 class="info">请您在新打开的页面上完成付款</h1>
            <p>付款完成前请不要关闭此窗口</p>
            <p>完成付款后请根据您的情况点击下面的按钮</p>
            <p class="ctrl">

                <a id="lightbox_payment_done" href="javascript:void(0);" class="formbutton">已完成付款</a>
                <a id="lightbox_payment_failed" href="javascript:void(0);" class="formbutton">付款遇到问题</a>
                <input type="button" id="btnZf" onclick="form_submit()" style="display: none;" value="立即支付">
            </p>
        </div>
    </div>
</div>

<script src="/style2/js/address.js" ></script>
<script type="text/javascript">
    var xsrf='{{handler.xsrf_token}}';
    var price = parseFloat('{{totalPrice}}');
    var shippingPrice = parseFloat('{{shopping_price}}');
    $(function(){
        initLocation({sheng_val:"陕西",shi_val:"西安",xian_val:"",xiang_val:""});

        $(".formbutton").click(function(){
            var url = '/ajax/check_pay';
            var ordnum = '';
            $.post(
                    url,
                    {_xsrf:xsrf},
                    function(data){
                        data = jQuery.parseJSON(data);
                        if(data.result == 'success'){
                            location.href="/user/order/"+data.orderid;
                        }else if(data.result == 'failure'){
                            location.href='/cart/check?onum='+data.ordernum;
                        }else{
                            location.href="/user/order";
                        }
                    }
            );
        });

        showCont();
        $("input[name=gateway]").click(function(){
            showCont();
        });
        $(".gateway_COD").click(function () {
            showCont();
        });
        function showCont() {
            switch ($("input[name=gateway]:checked").val()) {
                case "COD":
                    $("#check_pay_form").attr("target", "_self");
                    break;
                case "Alipay":
                    $("#check_pay_form").attr("target", "_blank");
                    break;
                case "Balance":
                    $("#check_pay_form").attr("target", "_self");
                    break;
            }
        }

        choose_promo_card();
        show_promo_card_box();

        if ({{totalPrice+shopping_price}}>{{balance}}){
        $('.checkBalance').show();
        $('.radioBalance').hide();
    }
    else{
        $('.checkBalance').hide();
        $('.radioBalance').show();
    }

    function show_promo_card_box(){

        $('.JS_use_promo_card').unbind('click');
        $('.JS_use_promo_card').click(function(e){
            e.preventDefault();
            var promo_card_box = $(this).parent().find(".promo_card_box");
            if(promo_card_box.css("display") == "none"){
                promo_card_box.show();
                $(this).children(0).html('-');
            }else{
                promo_card_box.hide();
                $(this).children(0).html('+');
            }
        });
    }

    function choose_promo_card(){
        //动态计算下拉框的高度和滚动条的显示
        var promo_box = $(".choose_promo_card_box"), promo_ul = promo_box.find("ul"), promo_li = promo_ul.eq(0).children(), promo_len = promo_li.length, height = 0;
        if(promo_len <= 4){
            promo_ul.css({"overflow-y":"hidden"});
        }
        promo_box.css('visibility', 'hidden').show();
        for(var i = 0; i < promo_len && i < 4; i++){
            height += promo_li.eq(i).outerHeight();
        }
        promo_ul.height(height - 1);
        promo_box.hide().css('visibility', 'visible');

        $('.choose_promo_card').unbind('click');
        $('.choose_promo_card').click(function(e){
            e.stopPropagation();
            e.preventDefault();

            //data
            var parent_box = $(this).closest('.order_amount_container').find('.choose_promo_card_box'),
                    box = $(parent_box).find('ul');


            parent_box.show();
            parent_box.focus();

            var li;
            li = $("li",box);
            box.find('li:last').css({'border':'none'});

            li.hover(function(){
                $(this).addClass('hover');
            },function(){
                $(this).removeClass('hover');
            });

            // 关闭按钮
            parent_box.find('.close_promo_card').click(function(e){
                e.preventDefault();
                parent_box.hide();
            });

            // 失焦关闭现金券列表
            $(parent_box).blur(function(){
                parent_box.hide();
            });

        });
        $(".choose_promo_card_box ul li").unbind('click');
        $(".choose_promo_card_box ul li").click(function(){
            var cart = $(this).closest('.cart_products_v2');
            var code = $(this).find(".promo_card_num").text();
            var price = $(this).find(".pink").text();
            //修改隐藏域
            $(cart).find(".J_Promo_cardno").val(code);
            $('#hdCouponPrice').val(price);
            if(!$(this).hasClass('disabled_click')){
                $(this).closest('.choose_promo_card_box').prev().find('.input_promo_card').val($(this).find('.promo_card_num').text());
                $(this).closest('.choose_promo_card_box').hide();
                // 选择现金券的同时进行提交操作
                $('.confirm_promo_card').show();
                update_price();
                $('.choose_promo_card').hide();


                $('.promo_card_text').html('已使用现金券：'+$(this).find(".sp_coupon_name").text());


            }
            return false;
        });
    }

    function autoclick() {
        $('.choose_promo_card').trigger("click");
    }

    function autocoupon(){
        $(".choose_promo_card_box ul li:first").trigger("click");
    }

    setTimeout( autoclick, 500 );
    setTimeout( autocoupon, 1000 );

    });

    function update_price(){

        var couponPrice = parseFloat($('#hdCouponPrice').val());

        var is_start = parseInt('{{is_start}}');
        var full_price = parseFloat('{{full_price}}');
        var reduce_price = parseFloat('{{reduce_price}}');
        var p = price + shippingPrice - couponPrice;
        var currentPrice = 0;
        if(is_start == 1 & p >= full_price){
            currentPrice = p - reduce_price;
            $("#mjhdTr").show();
        }else{
            currentPrice = p;
            $("#mjhdTr").hide();
        }
        $('#hdCurrentPrice').val(currentPrice);

        initPayment();

        //更新价格

        $('.total_amount').html(currentPrice.toFixed(2));
        $(".cart_products #cart_total").html(currentPrice.toFixed(2));
        $("#cart_total2").html(currentPrice.toFixed(2));
        $(".J_Red_totalPrice").val(currentPrice.toFixed(2));
        $(".getewey_price").html(currentPrice.toFixed(2));


    }

    function cancelCoupon(){
        $('#hdCouponPrice').val('0');
        $(".J_Promo_cardno").val('');
        update_price();
        $('.confirm_promo_card').hide();
        $('.choose_promo_card').show();
        $('.promo_card_text').html('使用现金券：');
    }

    function initPayment(){

        var balance = {{balance}};
    var currentPrice = $('#hdCurrentPrice').val();
    if (currentPrice > balance){
        //使用部分余额
        $('.checkBalance').show();
        $('#check-balance').attr('checked', false);
        $('.radioBalance').hide();
        $('#choose_before').attr('checked', true);
    }
    else{
        $('#check-balance').attr('checked', false);
        $('.checkBalance').hide();

        $('.radioBalance').show();
        $('#choose_before').attr('checked', true);
    }
    $('#hdBalance').val('0');
    }
    //默认的收货地址和支付网关
    var currentPageDefaultValue = {
        address_id: '46367589',
        payment_method: 'alipay',
        prefer_delivery_day: '',
        should_show_cod: '2',
        has_luxury_deal: false
    };
    var alert_message = false;
</script>

{% endblock %}